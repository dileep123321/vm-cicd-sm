name: Deploy Python Backend to GCP VM

on:
  push:
    branches: ["main"]

permissions:
  contents: read

env:
  PROJECT_ID: kxnwork
  VM_NAME: kxn-backend-vm-new01
  ZONE: asia-southeast1-a
  DEPLOY_USER: deployuser01
  SECRET_SSH: kxn-ssh-secret-new01
  SECRET_ENV: kxn-env-secret-new01

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}

      - name: Retrieve SSH private key
        run: |
          gcloud secrets versions access latest \
            --secret="${SECRET_SSH}" \
            --project="${PROJECT_ID}" > private_key
          chmod 600 private_key

      - name: Retrieve .env
        run: |
          gcloud secrets versions access latest \
            --secret="${SECRET_ENV}" \
            --project="${PROJECT_ID}" > app.env
          echo "::add-mask::$(cat app.env || true)"

      - name: Get VM IP
        id: vmip
        run: |
          VM_IP=$(gcloud compute instances describe "${VM_NAME}" \
            --project="${PROJECT_ID}" --zone="${ZONE}" \
            --format="get(networkInterfaces[0].accessConfigs[0].natIP)")
          echo "VM_IP=$VM_IP" >> $GITHUB_OUTPUT

      - name: Add VM to known_hosts
        run: ssh-keyscan -H ${{ steps.vmip.outputs.VM_IP }} >> ~/.ssh/known_hosts

      - name: Upload app files to VM
        run: |
          scp -i private_key -o StrictHostKeyChecking=yes -r ./* \
            "${DEPLOY_USER}"@${{ steps.vmip.outputs.VM_IP }}:/home/${DEPLOY_USER}/app

      - name: Upload environment file
        run: |
          scp -i private_key -o StrictHostKeyChecking=yes app.env \
            "${DEPLOY_USER}"@${{ steps.vmip.outputs.VM_IP }}:/home/${DEPLOY_USER}/app/.env

      - name: Install dependencies + Restart service
        run: |
          ssh -i private_key -o StrictHostKeyChecking=yes \
            "${DEPLOY_USER}"@${{ steps.vmip.outputs.VM_IP }} << 'EOS'
            set -e
            cd /home/${DEPLOY_USER}/app
            if [ ! -d /home/${DEPLOY_USER}/venv ]; then
              python3 -m venv /home/${DEPLOY_USER}/venv
            fi
            source /home/${DEPLOY_USER}/venv/bin/activate
            pip install --upgrade pip
            [ -f requirements.txt ] && pip install -r requirements.txt
            sudo systemctl restart kxn-backend-new01.service
            sudo systemctl status kxn-backend-new01.service --no-pager || true
EOS
